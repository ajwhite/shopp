<div class="wrap">
	<h2>Settings</h2>
	<?php include("navigation.html"); ?>

	<form name="settings" id="general" action="<?php echo $_SERVER['REQUEST_URI']; ?>" method="post">
		<table class="form-table"> 
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="merchant_email">Merchant Email</label></th> 
				<td><input type="text" name="settings[merchant_email]" value="<?php echo $this->Core->Settings->get('merchant_email'); ?>" id="merchant_email" size="30" /><br /> 
	            Enter the email address for the owner of this shop to receive e-mail notifications.</td>
			</tr>
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="base_operations">Base of Operations</label></th> 
				<td><select name="settings[base_operations][country]" id="base_operations">
					<option></option>
						<?php echo menuoptions($countries,$operations['country'],true); ?>
					</select>
					<select name="settings[base_operations][region]" id="base_operations_region">
						<?php if (isset($regions)) 
								echo menuoptions($regions,$operations['region'],true); ?>
					</select>
					<br /> 
	            Select your primary business location.</td> 
			</tr>
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="target_markets">Target Markets</label></th> 
				<td>
					<div class="multiple-select">
						<ul>
							
							<?php $even = true; foreach ($targets as $iso => $country): ?>
								<li<?php if ($even) echo ' class="odd"'; $even = !$even; ?>><input type="checkbox" name="settings[target_markets][<?php echo $iso; ?>]" value="<?php echo $country; ?>" id="market-<?php echo $iso; ?>" checked="checked" /><label for="market-<?php echo $iso; ?>"><?php echo $country; ?></label></li>
							<?php endforeach; ?>
							<li<?php if ($even) echo ' class="odd"'; $even = !$even; ?>><input type="checkbox" name="selectall_targetmarkets"  id="selectall_targetmarkets" /><label for="selectall_targetmarkets"><strong>Select All</strong></label></li>							
							<?php foreach ($countries as $iso => $country): ?>
							<?php if (!in_array($country,$targets)): ?>
							<li<?php if ($even) echo ' class="odd"'; $even = !$even; ?>><input type="checkbox" name="settings[target_markets][<?php echo $iso; ?>]" value="<?php echo $country; ?>" id="market-<?php echo $iso; ?>" /><label for="market-<?php echo $iso; ?>"><?php echo $country; ?></label></li>
							<?php endif; endforeach; ?>
						</ul>
					</div>
					<br /> 
	            Select the markets you are selling products to.</td> 
			</tr>
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="cart-toggle">Order Status Labels</label></th> 
				<td>
				<ol id="order-statuslabels">
				</ol>
				Add your own order processing labels to indicate the status of an order to your customers.</td>
			</tr>
		</table>

		<p class="submit"><input type="submit" class="button" name="save" value="Save Changes" /></p>
	</form>
</div>
<script type="text/javascript">
$j=jQuery.noConflict();

var labels = <?php echo json_encode($statusLabels); ?>;
var labelInputs = new Array();

if ($j('#base_operations').val() == '') $j('#base_operations_region').hide();

$j('#base_operations').change(function() {
	if ($j('#base_operations').val() == '') {
		$j('#base_operations_region').hide();
		return true;
	}

	$j.getJSON($j('#general').attr('action')+'&lookup=regions&country='+$j('#base_operations').val(),
		function(data) {
			$j('#base_operations_region').hide();
			$j('#base_operations_region').empty();
			if (!data) return true;
			
			$j.each(data, function(value,label) {
				option = $j('<option></option>').val(value).html(label).appendTo('#base_operations_region');
			});
			$j('#base_operations_region').show();
			
	});
});

$j('#selectall_targetmarkets').change(function() {
	$j('div.multiple-select ul li input').each( function () {
		if (this.id !== "selectall_targetmarkets") {
			if (this.checked) this.checked = false;
			else this.checked = true;
		}
	});
});

var addLabel = function (label,location) {
	
	var i = labelInputs.length;
	
	if (!location) var li = $j('<li id="item-'+i+'"></li>').appendTo('#order-statuslabels');
	else var li = $j('<li id="item-'+i+'"></li>').insertAfter(location);
	
	var wrap = $j('<span></span>').appendTo(li);
	var input = $j('<input type="text" name="settings[order_status][]" id="label['+i+']" size="14" />').appendTo(wrap);
	var deleteButton = $j('<button type="button" class="delete"></button>').prependTo(wrap).hide();
	var deleteIcon = $j('<img src="<?php echo SHOPP_PLUGINURI; ?>/core/ui/icons/delete.png" alt="Delete" width="16" height="16" />').appendTo(deleteButton);
	var addButton = $j('<button type="button" class="add"></button>').appendTo(li);
	var addIcon = $j('<img src="<?php echo SHOPP_PLUGINURI; ?>/core/ui/icons/add.png" alt="Add" width="16" height="16" />').appendTo(addButton);
	
	if (i > 0) {
		wrap.hover(function() {
			deleteButton.show();
		},function () {
			deleteButton.hide();
		});
	}
	
	addButton.click(function () {
		addLabel(null,'#'+$j(li).attr('id'));
	});
	
	deleteButton.click(function () {
		if (confirm("Are you sure you want to remove this order status label?"))
			li.remove();
	});
	
	if (label) input.val(label);
	
	labelInputs.push(li);
	
}

if (labels) {
	$j(labels).each(function(id,label) {
		addLabel(label);
	});
} else addLabel();

</script>