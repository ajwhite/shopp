<div class="wrap shopp">
	<?php if (!empty($updated)): ?><div id="message" class="updated fade"><p><?php echo $updated; ?></p></div><?php endif; ?>
	<h2>Shipping Settings</h2>
	<?php include("navigation.html"); ?>

	<form name="settings" id="shipping" action="<?php echo $_SERVER['REQUEST_URI']; ?>" method="post">
		<?php wp_nonce_field('shopp-settings-shipping'); ?>
		
		<table class="form-table"> 
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="shipping-toggle">Calculate Shipping</label></th> 
				<td><input type="hidden" name="settings[shipping]" value="off" /><input type="checkbox" name="settings[shipping]" value="on" id="shipping-toggle"<?php if ($this->Settings->get('shipping') == "on") echo ' checked="checked"'?> /><label for="shipping-toggle"> Enabled</label><br /> 
	            Check this to use shipping. Leave un-checked to disable shipping - helpful if you are only selling subscriptions or downloads.</td>
			</tr>
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="weight-units">Weight Unit</label></th> 
				<td>
				<select name="settings[weight_unit]" id="weight-unit">
					<option></option>
						<?php
							if ($base['units'] == "imperial") $units = array("oz" => "ounces (oz)","lb" => "pounds (lbs)");
							else $units = array("g"=>"gram (g)","kg"=>"kilogram (kg)");
							echo menuoptions($units,$this->Settings->get('weight_unit'),true);
						?>
				</select><br />
				Used as unit of weight for all products.</td>
			</tr>
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="free_shipping_text">Free Shipping Text</label></th> 
				<td><input type="text" name="settings[free_shipping_text]" value="<?php echo $this->Settings->get('free_shipping_text'); ?>" id="free_shipping_text"><br /> 
	            Text used to highlight no shipping costs (examples: Free shipping! or Shipping Included)</td>
			</tr>
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="outofstock-text">Out-of-stock Notice</label></th> 
				<td><input type="text" name="settings[outofstock_text]" value="<?php echo $this->Settings->get('outofstock_text'); ?>" id="outofstock-text"><br /> 
	            Text used to notify the customer the product is out-of-stock or on backorder.</td>
			</tr>
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="regional_rates">Domestic Regions</label></th> 
				<td><input type="hidden" name="settings[shipping_regions]" value="off" /><input type="checkbox" name="settings[shipping_regions]" value="on" id="regional_rates"<?php echo ($this->Settings->get('shipping_regions') == "on")?' checked="checked"':''; ?>><label for="regional_rates"> Enabled</label><br /> 
	            Used for domestic regional shipping rates (only applies to operations based in the U.S. &amp; Canada)<br />
				<strong>Note: </strong>You must click the "Save Changes" button for changes to take effect.</td>
			</tr>
		</table>

		<h3>Shipping Methods &amp; Rates</h3>
		<p><small>Shipping rates based on the order amount are calculated once against the order subtotal (which does not include tax).  Shipping rates based on weight are calculated once against the total order weight.  Shipping rates based on item quantity are calculated against the total quantity of each different item ordered.</small></p>
		<?php $base = $this->Settings->get('base_operations'); if (!empty($base['country'])): ?>
		<table id="shipping-rates" class="form-table"><tr><td></td></tr></table>
		<div class="tablenav"><div class="alignright"><button type="button" name="add-shippingrate" id="add-shippingrate" class="button-secondary" tabindex="9999">Add Shipping Method Rates</button></div></div>
		<?php else: ?>
			<p class="tablenav"><small><strong>Note:</strong> You must select a Base of Operations location under <a href="?page=<?php echo $this->Admin->settings ?>&amp;edit=general">General settings</a> before you can configure shipping rates.</small></p>
		<?php endif; ?>
		<p class="submit"><input type="submit" class="button" name="save" value="Save Changes" /></p>
	</form>
</div>

<script type="text/javascript">
helpurl = "<?php echo SHOPP_DOCS; ?>Shipping_Settings";

var currencyFormat = <?php $base = $this->Settings->get('base_operations'); echo json_encode($base['currency']['format']); ?>;
(function($) {
	
var addShippingRate = function (r) {
	if (!r) r = false;
	var i = shippingRates.length;
	var row = $('<tr class="form-field form-required"></tr>').appendTo($('#shipping-rates'));
	var heading = $('<th scope="row" valign="top"><label for="name['+i+']">Option Name</label></th>').appendTo(row);
	$('<br />').appendTo(heading);
	var name = $('<input type="text" name="settings[shipping_rates]['+i+'][name]" value="" id="name['+i+']" size="16" tabindex="'+(i+1)+'00" class="selectall" />').appendTo(heading);
	$('<br />').appendTo(heading);

	
	var deliveryTimesMenu = $('<select name="settings[shipping_rates]['+i+'][delivery]" id="delivery['+i+']" class="methods" tabindex="'+(i+1)+'01"></select>').appendTo(heading);
	var lastGroup = false;
	$.each(deliveryTimes,function(range,label){
		if (range.indexOf("group")==0) {
			lastGroup = $('<optgroup label="'+label+'"></optgroup>').appendTo(deliveryTimesMenu);	
		} else {
			if (lastGroup) $('<option value="'+range+'">'+label+'</option>').appendTo(lastGroup);
			else $('<option value="'+range+'">'+label+'</option>').appendTo(deliveryTimesMenu);
		}
	});

	$('<br />').appendTo(heading);
	
	var methodMenu = $('<select name="settings[shipping_rates]['+i+'][method]" id="method['+i+']" class="methods" tabindex="'+(i+1)+'02"></select>').appendTo(heading);
	var lastGroup = false;
	$.each(methods,function(m,methodtype){
		if (m.indexOf("group")==0) {
			lastGroup = $('<optgroup label="'+methodtype+'"></optgroup>').appendTo(methodMenu);	
		} else {
			if (lastGroup) $('<option value="'+m+'">'+methodtype+'</option>').appendTo(lastGroup);
			else $('<option value="'+m+'">'+methodtype+'</option>').appendTo(methodMenu);
		}
	});	
	var rateTableCell = $('<td/>').appendTo(row);
	var deleteRateButton = $('<button type="button" name="deleteRate" class="delete deleteRate"></button>').appendTo(rateTableCell).hide();
	$('<img src="<?php echo SHOPP_PLUGINURI; ?>/core/ui/icons/delete.png" width="16" height="16" />').appendTo(deleteRateButton);
	

	var rowBG = row.css("background-color");
	var deletingBG = "#ffebe8";
	row.hover(function () {
			deleteRateButton.show();
		}, function () {
			deleteRateButton.hide();
	});

	deleteRateButton.hover (function () {
			row.animate({backgroundColor:deletingBG},250);
		},function() {
			row.animate({backgroundColor:rowBG},250);		
	});

	deleteRateButton.click(function () {
		if (shippingRates.length > 1) {
			if (confirm("Are you sure you want to delete this product option?")) {
				row.remove();
				shippingRates.splice(i,1);
			}
		}
	});
		
	var rateTable = $('<table class="rate"/>').appendTo(rateTableCell);
	
	$(methodMenu).change(function() {
		methodHandlers.call($(this).val(),i,rateTable,r);
	});
	
	if (r) {
		name.val(r.name);
		methodMenu.val(r.method).change();
		deliveryTimesMenu.val(r.delivery);
	} else {
		methodMenu.change();
	}
	
	quickSelects();	
	shippingRates.push(row);
	
}

var methodHandlers = new CallbackRegistry();

<?php $Shopp->ShipCalcs->ui(); ?>

if ($('#shipping-rates')) {
	var shippingRates = new Array();
	var rates = <?php echo json_encode($rates); ?>;
	var methods = <?php echo json_encode($methods); ?>;
	var deliveryTimes = {"prompt":"Delivery time&hellip;","group1":"Business Days","1d-1d":"1 business day","1d-2d":"1-2 business days","1d-3d":"1-3 business days","1d-5d":"1-5 business days","2d-3d":"2-3 business days","2d-5d":"2-5 business days","2d-7d":"2-7 business days","3d-5d":"3-5 business days","group2":"Weeks","1w-2w":"1-2 weeks","2w-3w":"2-3 weeks"};
	var domesticAreas = <?php echo json_encode($areas); ?>;
	var region = '<?php echo $region; ?>';
	
	
	$('#add-shippingrate').click(function() {
		addShippingRate();
	});

	$('#shipping-rates').empty();
	if (!rates) $('#add-shippingrate').click();
	else {
		$.each(rates,function(i,rate) {
			addShippingRate(rate);
		});	
	}
}

})(jQuery)

</script>