<div class="wrap">
	<h2>Upgrade Settings</h2>
	<?php include("navigation.html"); ?>

	<form name="settings" id="general" action="<?php echo $_SERVER['REQUEST_URI']; ?>" method="post">
		<table class="form-table"> 
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="showcase-order">Shopp Updates</label>
				</th> 
				<td>Currently running Shopp <?php echo SHOPP_VERSION; ?>
					<div id="update-info">
					<p><button type="button" id="check-update" name="check-update" class="button-secondary">Check for Updates</button></p>	
					</div>
					</td>
			</tr>			
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="Update Key">Update Key</label></th> 
				<td>
					<?php if ($this->Settings->get('updatekey_status') == "activated"): ?>
						<input type="text" name="settings[update_key]" id="update-key" size="40" value="<?php echo $this->Settings->get('update_key'); ?>" readonly="readonly" />
					<input type="submit" id="deactivate-button" name="activation" value="De-activate Key" class="button" />
					<?php else: ?>
					<input type="text" name="settings[update_key]" id="update-key" size="40" value="<?php echo $this->Settings->get('update_key'); ?>" />
					<input type="submit" id="activate-button" name="activation" value="Activate Key" class="button" />
					<?php endif; ?>
					<br /><?php echo $activation; ?>
	            </td>
			</tr>			
		</table>
	</form>
</div>

<script type="text/javascript">
(function($) {
	var ajaxurl = '<?php bloginfo('siteurl'); ?>/wp-admin/admin-ajax.php';
	var adminurl = '<?php bloginfo('siteurl'); ?>/wp-admin/admin.php';

	$('#check-update').click(function () {
		var target = $('#update-info')
		$.getJSON(ajaxurl+"?action=wp_ajax_shopp_version_check",function (result) {
			var data = eval(result);
			if (data.update) {
				target.html('<strong>Shopp '+data.version+' is available!</strong>');
				<?php if ($this->Settings->get('updatekey_status') == "activated"): ?>
				var wrap = $('<p></p>').appendTo(target);
				var update = $('<button type="button" name="update" id="update" class="button-secondary">Update Shopp</button>').appendTo(wrap);
				update.click(function () {
					target.html('<div id="status" class="updating">Updating Shopp&hellip; be patient!</div>');
					startupdate();
				});				
				<?php endif; ?>
			}
			else target.html("<strong>Shopp is up-to-date!</strong>");
		});
	});

	function startupdate () {
		$.get(ajaxurl+"?action=wp_ajax_shopp_update",function (result) {
			if (result == "ftp-failed") window.location.href = adminurl+"?page=shopp/settings&edit=ftp";
			if (result == "updated") {
				$('#update-info').html('<strong>Update Complete!</strong><br />Click continue to upgrade the Shopp database.');
				var wrap = $('<p></p>').appendTo('#update-info');
				var reload = $('<button type="button" name="reload" value="reload" class="button-secondary">Continue&hellip;</button>').appendTo('#update-info');
				reload.click(function () {
					window.location.href = adminurl+'?page=shopp/settings&edit=update&updated=true';
				});
			}
		});
	}
	
})(jQuery)
</script>