<div class="wrap shopp">
	<h2>Tax Settings</h2>
	<?php include("navigation.html"); ?>

	<form name="settings" id="general" action="<?php echo $_SERVER['REQUEST_URI']; ?>" method="post">
		<table class="form-table"> 
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="taxes-toggle">Calculate Taxes</label></th> 
				<td><input type="hidden" name="settings[taxes]" value="off" /><input type="checkbox" name="settings[taxes]" value="on" id="taxes-toggle"<?php if ($this->Settings->get('taxes') == "on") echo ' checked="checked"'?> /><label for="taxes-toggle"> Enabled</label><br /> 
	            Enables tax calculations.  Disable if you are exclusively selling non-taxable items.</td>
			</tr>
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="taxrate[i]">Tax Rates</label></th> 
				<td>
					<?php if ($this->Settings->get('target_markets')): ?>
					<table id="taxrates-table"><tr><td></td></tr></table>
	            <button type="button" id="add-taxrate" class="button-secondary"><img src="<?php echo SHOPP_PLUGINURI; ?>/core/ui/icons/add.png" alt="+" width="16" height="16" /> Add a Tax Rate</button>
					<?php else: ?>
					<p><strong>Note: </strong>You must select the target markets you will be selling to under <a href="?page=<?php echo $this->Admin->settings ?>&amp;edit=general">General settings</a> before you can setup tax rates.</p>
					<?php endif; ?>
				</td> 
			</tr>

		</table>
		<p class="submit"><input type="submit" class="button" name="save" value="Save Changes" /></p>
	</form>
</div>

<script type="text/javascript">
//<![CDATA[
(function($) {

var disableZonesInUse = function () {
	$('#taxrates-table tr select.zone option').each (function () {
		if ($.inArray($(this).val(),zonesInUse) != -1 && !this.selected)
			$(this).attr({'disabled':'disabled'});
	});
}

var addTaxRate = function (r) {
	i = taxrates.length;
	var row = $('<tr/>').appendTo('#taxrates-table');
	
	var rateCell = $('<td></td>').html(' %').appendTo(row);
	var rate = $('<input type="text" name="settings[taxrates]['+i+'][rate]" value="" id="settings-taxrates-'+i+'-rate" size="4" class="selectall right" />').prependTo(rateCell);
	var deleteButton = $('<button id="deleteButton-'+i+'" class="deleteButton" type="button" title="Delete tax rate"></button>').prependTo(rateCell).hide();
	var deleteIcon = $('<img src="<?php echo SHOPP_PLUGINURI; ?>/core/ui/icons/delete.png" width="16" height="16" />').appendTo(deleteButton);
	
	var countryCell = $('<td></td>').appendTo(row);
	var countryMenu = $('<select name="settings[taxrates]['+i+'][country]" id="country-'+i+'"></select>').appendTo(countryCell);
	
	$.each(countries, function(value,label) {
		option = $('<option></option>').val(value).html(label).appendTo(countryMenu);
	});
	
	var zoneCell = $('<td></td>').appendTo(row);
	var zoneMenu = $('<select name="settings[taxrates]['+i+'][zone]" id="zone-'+i+'" class="zone"></select>').appendTo(zoneCell);

	var updateZoneMenu = function () {
		zoneMenu.empty();
		if (zones[$(countryMenu).val()]) {
			$.each(zones[$(countryMenu).val()], function(value,label) {
				if ($.inArray(value,zonesInUse) != -1) option = $('<option disabled="disabled"></option>').val(value).html(label).appendTo(zoneMenu);				
				else option = $('<option></option>').val(value).html(label).appendTo(zoneMenu);
			});
		}
		if (zoneMenu.children().length == 0) zoneMenu.hide();
		else zoneMenu.show();
	}
	
	$(row).hover(function() {
			if (i > 0) deleteButton.show();
		},function() {
			deleteButton.hide();
	});
	
	$(deleteButton).click(function () {
		if (taxrates.length > 1) {
			if (confirm("Are you sure you want to delete this tax rate?")) {
				row.remove();
				taxrates.splice(i,1);
			}
		}
	});
	
	$(countryMenu).change(function () {
		updateZoneMenu();
	}).change();
	
	$(zoneMenu).change(function () {
		if ($.inArray(currentZone,zonesInUse) != -1)
			zonesInUse.splice($.inArray(currentZone,zonesInUse),1);
		currentZone = $(zoneMenu).val();
		zonesInUse.push(currentZone);
		disableZonesInUse();
	});
	
	if (r) {
		rate.val(r.rate);
		countryMenu.val(r.country).change();
		zoneMenu.val(r.zone).change();
	} else {
		countryMenu.val(base.country).change();
		if ($.inArray(base.zone,zonesInUse) == -1)
			zoneMenu.val(base.zone).change();
		else zoneMenu.change();
	}
	
	var currentZone = zoneMenu.val();
	console.log($(zoneMenu).attr('selected'));

	taxrates.push(row);
	quickSelects();
	
}

if ($('#taxrates-table')) {
	var rates = <?php echo json_encode($rates); ?>;
	var base = <?php echo json_encode($base); ?>;
	var countries = <?php echo json_encode($countries); ?>;
	var zones = <?php echo json_encode($zones); ?>;
	var taxrates = new Array();
	var zonesInUse = new Array();


	$('#add-taxrate').click(function() {
		addTaxRate();
	});

	$('#taxrates-table').empty();
	if (rates) {
		for (i in rates) {
			addTaxRate(rates[i]);
		}
	} else addTaxRate();	
}
})(jQuery)

//]]>
</script>