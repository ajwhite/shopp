<div class="wrap">
	<h2>Tax Settings</h2>
	<?php include("navigation.html"); ?>

	<form name="settings" id="general" action="<?php echo $_SERVER['REQUEST_URI']; ?>" method="post">
		<table class="form-table"> 
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="taxes-toggle">Calculate Taxes</label></th> 
				<td><input type="hidden" name="settings[taxes]" value="off" /><input type="checkbox" name="settings[taxes]" value="on" id="taxes-toggle"<?php if ($this->Settings->get('taxes') == "on") echo ' checked="checked"'?> /><label for="taxes-toggle"> Enabled</label><br /> 
	            Enables tax calculations.  Disable if you are exclusively selling non-taxable items.</td>
			</tr>
			<tr class="form-field form-required"> 
				<th scope="row" valign="top"><label for="taxrate[i]">Tax Rates</label></th> 
				<td>
					<?php if ($this->Settings->get('target_markets')): ?>
					<table id="taxrates-table"><tr><td></td></tr></table>
	            <button type="button" id="add-taxrate" class="button-secondary"><img src="<?php echo SHOPP_PLUGINURI; ?>/core/ui/icons/add.png" alt="+" width="16" height="16" /> Add a Tax Rate</button>
					<?php else: ?>
					<p><strong>Note: </strong>You must select the target markets you will be selling to under <a href="?page=<?php echo $this->Admin->settings ?>&amp;edit=general">General settings</a> before you can setup tax rates.</p>
					<?php endif; ?>
				</td> 
			</tr>

		</table>
		<p class="submit"><input type="submit" class="button" name="save" value="Save Changes" /></p>
	</form>
</div>

<script type="text/javascript">
//<![CDATA[
$j=jQuery.noConflict();

var disableZonesInUse = function () {
	$j('#taxrates-table tr select.zone option').each (function () {
		if ($j.inArray($j(this).val(),zonesInUse) != -1 && !this.selected)
			$j(this).attr({'disabled':'disabled'});
	});
}

var addTaxRate = function (r) {
	i = taxrates.length;
	var row = $j('<tr/>').appendTo('#taxrates-table');
	
	var rateCell = $j('<td></td>').html(' %').appendTo(row);
	var rate = $j('<input type="text" name="settings[taxrates]['+i+'][rate]" value="" id="settings[taxrates]['+i+'][rate]" size="4" class="selectall right" />').prependTo(rateCell);
	var deleteButton = $j('<button id="deleteButton['+i+']" class="deleteButton" type="button" title="Delete product option"></button>').prependTo(rateCell).hide();
	var deleteIcon = $j('<img src="<?php echo SHOPP_PLUGINURI; ?>/core/ui/icons/delete.png" width="16" height="16" />').appendTo(deleteButton);
	
	var countryCell = $j('<td></td>').appendTo(row);
	var countryMenu = $j('<select name="settings[taxrates]['+i+'][country]" id="country['+i+']"></select>').appendTo(countryCell);
	
	$j.each(countries, function(value,label) {
		option = $j('<option></option>').val(value).html(label).appendTo(countryMenu);
	});
	
	var zoneCell = $j('<td></td>').appendTo(row);
	var zoneMenu = $j('<select name="settings[taxrates]['+i+'][zone]" id="zone['+i+']" class="zone"></select>').appendTo(zoneCell);

	var updateZoneMenu = function () {
		zoneMenu.empty();
		if (zones[$j(countryMenu).val()]) {
			$j.each(zones[$j(countryMenu).val()], function(value,label) {
				if ($j.inArray(value,zonesInUse) != -1) option = $j('<option disabled="disabled"></option>').val(value).html(label).appendTo(zoneMenu);				
				else option = $j('<option></option>').val(value).html(label).appendTo(zoneMenu);
			});
		}
	}
	
	$j(row).hover(function() {
			if (i > 0) deleteButton.show();
		},function() {
			deleteButton.hide();
	});
	
	$j(deleteButton).click(function () {
		if (taxrates.length > 1) {
			if (confirm("Are you sure you want to delete this tax rate?")) {
				row.remove();
				taxrates.splice(i,1);
			}
		}
	});
	
	
	$j(countryMenu).change(function () {
		updateZoneMenu();
	}).change();
	
	$j(zoneMenu).change(function () {
		if ($j.inArray(currentZone,zonesInUse) != -1)
			zonesInUse.splice($j.inArray(currentZone,zonesInUse),1);
		currentZone = $j(zoneMenu).val();
		zonesInUse.push(currentZone);
		disableZonesInUse();
	});
	
	if (r) {
		rate.val(r.rate);
		countryMenu.val(r.country).change();
		zoneMenu.val(r.zone).change();
	} else {
		countryMenu.val(base.country).change();
		if ($j.inArray(base.zone,zonesInUse) == -1)
			zoneMenu.val(base.zone).change();
		else zoneMenu.change();
	}

	var currentZone = zoneMenu.val();

	taxrates.push(row);
	quickSelects();
	
}

if ($j('#taxrates-table')) {
	var rates = <?php echo json_encode($rates); ?>;
	var base = <?php echo json_encode($base); ?>;
	var countries = <?php echo json_encode($countries); ?>;
	var zones = <?php echo json_encode($zones); ?>;
	var taxrates = new Array();
	var zonesInUse = new Array();


	$j('#add-taxrate').click(function() {
		addTaxRate();
	});

	$j('#taxrates-table').empty();
	if (rates.length > 0) for(i = 0; i < rates.length; i++) addTaxRate(rates[i]);
	else addTaxRate();	
}
//]]>
</script>