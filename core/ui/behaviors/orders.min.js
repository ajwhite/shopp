/*
 * orders.js - Behaviors for the order manager
 * Copyright Â© 2011 by Ingenesis Limited. All rights reserved.
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(h){h.template("shipment-ui",h("#shipment-ui"));h.template("shipnotice-ui",h("#shipnotice-ui"));h.template("refund-ui",h("#refund-ui"));h.template("address-ui",h("#address-editor"));h.template("customer-ui",h("#customer-editor"));h.template("customer-select",h("#customer-selector"));h.template("change-customer",h("#change-customer-ui"));var g=h("#order-manage"),f=g.find("div.manager-ui"),i="",d=h.each(carriers,function(l,m){i+='<option value="'+l+'">'+m[0]+"</option>"}),k=h("#shipnote-button").click(function(s){s.preventDefault();var r=h(this).hide(),q=[],p=h.tmpl("shipnotice-ui",{shipmentnum:2}),m=p.find("ol li"),o=function(){m.find("span.number").text(q.length+1+".")},l=p.find("#addship-button").click(function(x){x.preventDefault();var v=q.length,w=h.tmpl("shipment-ui",{id:v,num:v+1}),u=w.find("select").html(i),y=w.find(".tracking").change(function(){var z=h(this).val().toUpperCase().replace(/[^A-Z0-9]/,"");h.each(carriers,function(B,A){if(z.match(new RegExp(A[1].substr(1,A[1].length-2)))!=null){u.val(B);return false}})}),t=w.find("button.delete").click(function(z){z.preventDefault();w.remove();q.splice(v,1);o()}).hide();if(v>0){w.hover(function(){t.show()},function(){t.fadeOut("fast")})}q.push(w.insertBefore(m));o()}).click(),n=p.find("#cancel-ship").click(function(t){t.preventDefault();p.fadeRemove("fast",function(){r.show()})});f.empty().append(p)}),j=h("#cancel-order, #refund-button").click(function(p){p.preventDefault();var o=h(this).attr("disabled",true),n=("refund-button"==o.attr("id")?{action:"refund",title:$om.ro,cancel:$om.cancel,send:$om.stg,process:$om.pr,reason:$om.rr}:{action:"cancel",title:$om.co,cancel:$om.dnc,send:$om.stg,process:$om.co,reason:$om.rc,disable_amount:' disabled="disabled"'}),m=h.tmpl("refund-ui",n),l=m.find("#cancel-refund").click(function(q){q.preventDefault();m.fadeRemove("fast",function(){o.show()})});f.empty().append(m)}),e=h("#print-button").click(function(n){n.preventDefault();var o=h("#print-receipt").get(0),l=o.contentWindow;if(h.browser.opera||h.browser.msie){var m=window.open(l.location.href+"&print=auto");h(m).load(function(){m.close()})}else{l.focus();l.print()}return false}),a=function(m){var r=h(this),p=address[m],o=h.tmpl("address-ui",p),l=h("#"+m+"-address-editor"),q=h("#order-"+m+" .display"),n=o.find("#cancel-edit-address").click(function(s){s.preventDefault();o.fadeRemove("fast",function(){r.show();q.show()})});o.find("#address-state-menu").html(p.statemenu);o.find("#address-country").upstate().html(p.countrymenu);q.hide();l.hide().empty().append(o).slideDown("fast")},c=h("#edit-billing-address, #order-billing address").click(function(l){l.preventDefault();a("billing");return false}),c=h("#edit-shipping-address, #order-shipto address").click(function(l){l.preventDefault();a("shipping");return false}),b=h("#edit-customer").click(function(n){n.preventDefault();var p=h(this),r=h.tmpl("customer-ui",customer),s=h("#customer-editor-form"),o=h("#order-contact .display"),l=h("#order-contact .inside"),t=function(u){u.preventDefault();r.fadeRemove("fast",function(){p.show();o.show()})},q=r.find("#change-customer").click(function(A){A.preventDefault();s.hide();r=h.tmpl("change-customer");var x=h("#change-customer-editor").empty().append(r).slideDown("fast");var w=x.find("#customer-search-results").hide(),z=x.find(".change-button").hide(),y=h("#cancel-change-customer").hide(),v=r.find("#cancel-edit-customer").click(t),u=h("#customer-search").submit(function(B){h("#change-customer").hide();y.show().click(t);w.show()})}),m=r.find("#cancel-edit-customer").click(t);o.hide();s.hide().empty().append(r).slideDown("fast");return false})});